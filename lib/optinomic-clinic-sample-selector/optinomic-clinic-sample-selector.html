<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<!--
`optinomic-clinic-sample-selector`
Selects current clinic-sample based on the clinic-sample md-array.

@demo demo/index.html 
-->
<dom-module id="optinomic-clinic-sample-selector">
    <template>
        <style include="shared-styles iron-flex iron-flex-alignment">
        :host {
            display: block;
        }
        
        .clear-button {
            visibility: hidden;
        }
        </style>
        <template is="dom-if" if="[[horizontal]]">
            <div class="layout horizontal">
                <template is="dom-repeat" items="[[clinic_sample.dimensions]]" as="d">
                    <vaadin-combo-box id$="[[index]]" label="[[d.name]]" items="[[d.array]]" item-label-path="text" item-value-path="id" value="[[d.selected]]" on-value-changed="__valueChanged" required auto-validate error-message="'This is required'">
                        <paper-icon-button icon="remove-circle" class="clear-button"></paper-icon-button>
                        <template>
                            [[item.text]]
                        </template>
                    </vaadin-combo-box>
                </template>
            </div>
        </template>
        <template is="dom-if" if="[[!horizontal]]">
            <div>
                <template is="dom-repeat" items="[[clinic_sample.dimensions]]" as="d">
                    <vaadin-combo-box id$="[[index]]" label="[[d.name]]" items="[[d.array]]" item-label-path="text" item-value-path="id" value="[[d.selected]]" on-value-changed="__valueChanged" required auto-validate error-message="'This is required'">
                        <paper-icon-button icon="remove-circle" class="clear-button"></paper-icon-button>
                        <template>
                            [[item.text]]
                        </template>
                    </vaadin-combo-box>
                </template>
            </div>
        </template>
    </template>
    <script>
    Polymer({

        is: 'optinomic-clinic-sample-selector',

        __init: function() {
            // INIT Properties
            this.clinic_sample = this.clinic_sample === undefined ? {} : this.clinic_sample;
            this.data_dive = this.data_dive === undefined ? [] : this.data_dive;
            this.data_dive_path = this.data_dive_path === undefined ? "statistics.paranoides_denken_scale_score" : this.data_dive_path;

            this.return_data = this.return_data === undefined ? {} : this.return_data;



            this.demo3_value = 1;
            this.demo3_items = [{
                label: 'zero',
                value: 0
            }, {
                label: 'one',
                value: 1
            }];


            this.__setDefault();
            this.__getDataDiveObj();

        },

        __setDefault: function() {
            var dimensions = this.get('clinic_sample.dimensions');
            var data_dive = this.get('data_dive');

            if (dimensions.length > 0) {
                dimensions.forEach(function(dimension, dimensionID) {
                    dimension.selected = data_dive[dimensionID];
                    dimension.array.forEach(function(array, arrayID) {
                        array.value = array.id;
                    });
                });
            };

            this.set('clinic_sample.dimensions', dimensions);
            console.log('__setDefault', dimensions);
        },

        __valueChanged: function(event) {

            var event_id = parseInt(event.srcElement.id);
            var event_value = event.detail.value;

            var dimensions = this.get('clinic_sample.dimensions');
            var data_dive = this.get('data_dive');



            if ((event_value === "") || (event_value === NaN)) {
                event_value = dimensions[event_id].array.length - 1;
            };

            console.log('1) __valueChanged', event_id, event_value, dimensions, data_dive);


            dimensions[event_id].selected = event_value;
            this.set('clinic_sample.dimensions', dimensions);

            data_dive[event_id] = event_value;
            this.set('data_dive', data_dive);

            console.log('__valueChanged', event_id, event_value, dimensions, data_dive);

            // Update return_data
            this.__getDataDiveObj();

        },

        __getDataDiveObj: function() {
            var data = this.get('clinic_sample.data');
            var data_dive = this.get('data_dive');
            var data_dive_path = this.get('data_dive_path');
            var data_dive_path_dots_count = (data_dive_path.split(".").length - 1);

            // Dive into data_dive 
            var return_obj = JSON.parse(JSON.stringify(data));
            data_dive.forEach(function(dive, diveID) {
                return_obj = return_obj[dive];
            });

            // Dive into data_dive_path if available 
            if (data_dive_path !== "") {
                if (data_dive_path_dots_count === 0) {
                    return_obj = return_obj[data_dive_path];
                } else {
                    var dive = [];
                    for (i = 0; i < data_dive_path_dots_count; i++) {
                        var n = data_dive_path.indexOf(".");
                        var item = data_dive_path.substring(0, n);
                        data_dive_path = data_dive_path.substring(n + 1, data_dive_path.length);
                        dive.push(item);
                        if (i === data_dive_path_dots_count - 1) {
                            dive.push(data_dive_path);
                        };
                    };

                    for (i = 0; i < dive.length; i++) {
                        return_obj = return_obj[dive[i]];
                        console.log('return_obj', return_obj);
                    };
                };
            };

            this.set('return_data', return_obj);
            console.log('__getDataDiveObj', data_dive, return_obj);
        },


        ready: function() {
            this.__init();
        },

        attached: function() {},

        properties: {
            data_dive: {
                type: Array,
                notify: true
            },
            data_dive_path: {
                type: String
            },
            clinic_sample: {
                type: Object
            },
            return_data: {
                type: Object,
                notify: true
            },
            horizontal: {
                type: Boolean,
                value: false
            }
        }

    });
    </script>
</dom-module>
